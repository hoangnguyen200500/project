<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Data Visualization</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/heatmap.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="container mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center">Student Data Analysis</h1>
        <div class="grid grid-cols-1 gap-6">
            <div class="bg-white p-4 rounded shadow">
                <div id="stackedBarChart" class="h-96"></div>
            </div>
            <div class="bg-white p-4 rounded shadow">
                <div id="lineChart" class="h-96"></div>
            </div>
            <div class="bg-white p-4 rounded shadow">
                <div id="heatmap" class="h-96"></div>
            </div>
        </div>
    </div>

    <script>
        async function fetchData() {
            try {
                const response = await fetch('http://127.0.0.1:5000/api/students');
                const data = await response.json();
                renderCharts(data);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function renderCharts(data) {
            // Stacked Bar Chart
            const enrolled1st = data.map(d => d['Curricular units 1st sem (enrolled)']);
            const approved1st = data.map(d => d['Curricular units 1st sem (approved)']);
            const withoutEval1st = data.map(d => d['Curricular units 1st sem (without evaluations)']);
            const enrolled2nd = data.map(d => d['Curricular units 2nd sem (enrolled)']);
            const approved2nd = data.map(d => d['Curricular units 2nd sem (approved)']);
            const withoutEval2nd = data.map(d => d['Curricular units 2nd sem (without evaluations)']);

            Highcharts.chart('stackedBarChart', {
                chart: { type: 'bar' },
                title: { text: 'Curricular Units Analysis by Semester' },
                xAxis: { categories: ['1st Semester', '2nd Semester'] },
                yAxis: { title: { text: 'Number of Units' } },
                plotOptions: { series: { stacking: 'normal' } },
                series: [
                    { name: 'Enrolled', data: [enrolled1st.reduce((a, b) => a + b, 0), enrolled2nd.reduce((a, b) => a + b, 0)] },
                    { name: 'Approved', data: [approved1st.reduce((a, b) => a + b, 0), approved2nd.reduce((a, b) => a + b, 0)] },
                    { name: 'Without Evaluations', data: [withoutEval1st.reduce((a, b) => a + b, 0), withoutEval2nd.reduce((a, b) => a + b, 0)] }
                ]
            });

            // Line Chart
            const evaluations1st = data.map(d => d['Curricular units 1st sem (evaluations)']);
            const evaluations2nd = data.map(d => d['Curricular units 2nd sem (evaluations)']);
            const grade1st = data.map(d => d['Curricular units 1st sem (grade)']);
            const grade2nd = data.map(d => d['Curricular units 2nd sem (grade)']);

            Highcharts.chart('lineChart', {
                chart: { type: 'line' },
                title: { text: 'Evaluations and Average Grades by Semester' },
                xAxis: { categories: ['1st Semester', '2nd Semester'] },
                yAxis: { title: { text: 'Value' } },
                series: [
                    { name: 'Evaluations', data: [evaluations1st.reduce((a, b) => a + b, 0), evaluations2nd.reduce((a, b) => a + b, 0)] },
                    { name: 'Average Grade', data: [
                        grade1st.reduce((a, b) => a + b, 0) / grade1st.length || 0,
                        grade2nd.reduce((a, b) => a + b, 0) / grade2nd.length || 0
                    ] }
                ]
            });

            // Heatmap
            const features = [
                'Admission grade', 
                'Age at enrollment', 
                'Tuition fees up to date', 
                'Debtor', 
                'Scholarship holder'
            ];
            const targetValues = ['Dropout', 'Enrolled', 'Graduate'];
            const heatmapData = [];

            features.forEach((feature, i) => {
                targetValues.forEach((target, j) => {
                    const featureValues = data
                        .filter(d => d.target === target)
                        .map(d => d[feature]);
                    const avgValue = featureValues.length ? featureValues.reduce((a, b) => a + b, 0) / featureValues.length : 0;
                    heatmapData.push([i, j, avgValue]);
                });
            });

            Highcharts.chart('heatmap', {
                chart: { type: 'heatmap' },
                title: { text: 'Correlation Heatmap with Target' },
                xAxis: { categories: features },
                yAxis: { categories: targetValues, title: { text: 'Target' } },
                colorAxis: { min: 0, minColor: '#FFFFFF', maxColor: Highcharts.getOptions().colors[0] },
                series: [{
                    name: 'Feature-Target Correlation',
                    borderWidth: 1,
                    data: heatmapData,
                    dataLabels: { enabled: true, color: '#000000' }
                }]
            });
        }

        fetchData();
    </script>
</body>
</html>